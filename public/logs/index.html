<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>æ—¥å¿—å¯è§†åŒ– | ZDXçš„å°ä¸–ç•Œ</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Courier New', Courier, monospace;
    }
    /* ç³»ç»ŸèƒŒæ™¯å±‚ï¼šå¤ç”¨ä¸»é¡µé¢æ·±è‰²èƒŒæ™¯ */
    body {
      background-color: #0a0a0a;
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: flex-start;
      padding: 20px 0;
      overflow-x: hidden;
    }
    /* ç»ˆç«¯èƒŒæ™¯å±‚ï¼šå®Œå…¨å¤ç”¨ä¸»é¡µé¢ç»ˆç«¯å®¹å™¨æ ·å¼ */
    .terminal {
      width: 100%;
      max-width: 1000px;
      min-width: 300px;
      background-color: #000;
      border-radius: 24px;
      padding: 30px 20px;
      position: relative;
      overflow: hidden;
      box-shadow: 0 0 50px rgba(0, 255, 0, 0.2);
      margin: 20px;
      flex-shrink: 0;
    }
    /* åƒç´ ç½‘æ ¼èƒŒæ™¯ï¼šå¤ç”¨ä¸»é¡µé¢ç½‘æ ¼æ•ˆæœ */
    .terminal::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-image: linear-gradient(rgba(60, 255, 60, 0.1) 1px, transparent 1px),
                        linear-gradient(90deg, rgba(60, 255, 60, 0.1) 1px, transparent 1px);
      background-size: 15px 15px;
      z-index: 1;
      pointer-events: none;
    }
    /* é¡¶éƒ¨æ ï¼šå¤ç”¨ä¸»é¡µé¢é¡¶éƒ¨å¸ƒå±€ */
    .terminal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 30px;
      position: relative;
      z-index: 2;
    }
    .terminal-header .date {
      display: flex;
      gap: 15px;
    }
    .terminal-header span {
      color: #3cff3c;
      font-size: 18px;
      font-weight: bold;
      letter-spacing: 1px;
    }
    .terminal-header .actions {
      display: flex;
      gap: 10px;
    }
    .terminal-header .actions button {
      background: transparent;
      border: 1px solid #3cff3c;
      color: #3cff3c;
      width: 36px;
      height: 36px;
      border-radius: 50%;
      font-size: 16px;
      cursor: pointer;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .terminal-header .actions button:hover {
      background: rgba(60, 255, 60, 0.2);
    }
    /* ä¸»æ ‡é¢˜ï¼šå¤ç”¨ä¸»é¡µé¢æ ‡é¢˜æ ·å¼ */
    .terminal-title {
      color: #3cff3c;
      font-size: 24px;
      line-height: 1.4;
      margin-bottom: 40px;
      position: relative;
      z-index: 2;
      letter-spacing: 2px;
      text-align: center;
      font-weight: bold;
      height: 34px;
      overflow: hidden;
    }
    /* æ—¥å¿—æ ‡ç­¾æ ï¼šä»…ä¿ç•™è®¿é—®æ—¥å¿—æ ‡ç­¾ */
    .log-tabs {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
      position: relative;
      z-index: 2;
    }
    .log-tab {
      flex: 1;
      background: transparent;
      border: 1px solid #3cff3c;
      color: #3cff3c;
      padding: 10px;
      border-radius: 8px;
      font-size: 16px;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.2s ease;
      text-align: center;
    }
    .log-tab.active {
      background: rgba(60, 255, 60, 0.2);
      border-color: #66ff66;
      box-shadow: 0 0 10px rgba(60, 255, 60, 0.3);
    }
    /* æ—¥æœŸé€‰æ‹©åŒºåŸŸæ ·å¼ */
    .date-selector {
      display: flex;
      gap: 15px;
      margin-bottom: 20px;
      position: relative;
      z-index: 2;
      align-items: center;
    }
    .date-picker {
      flex: 1;
      background: rgba(0, 40, 0, 0.6);
      border: 1px solid #3cff3c;
      border-radius: 8px;
      padding: 8px 12px;
      color: #3cff3c;
      font-size: 14px;
      outline: none;
      font-family: inherit;
    }
    .log-file-list {
      width: 200px;
      background: rgba(0, 40, 0, 0.6);
      border: 1px solid #3cff3c;
      border-radius: 8px;
      max-height: 150px;
      overflow-y: auto;
      color: #3cff3c;
      font-size: 14px;
    }
    .log-file-item {
      padding: 8px 12px;
      cursor: pointer;
      border-bottom: 1px solid rgba(60, 255, 60, 0.1);
      transition: all 0.2s ease;
    }
    .log-file-item:hover {
      background: rgba(60, 255, 60, 0.2);
    }
    .log-file-item.active {
      background: rgba(60, 255, 60, 0.3);
      font-weight: bold;
    }
    /* ç»Ÿè®¡é¢æ¿æ ·å¼ */
    .stats-panel {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin-bottom: 20px;
      position: relative;
      z-index: 2;
    }
    .stats-card {
      background-color: rgba(0, 40, 0, 0.4);
      border: 1px solid #3cff3c;
      border-radius: 8px;
      padding: 15px;
      color: #3cff3c;
    }
    .stats-card h3 {
      font-size: 16px;
      margin-bottom: 10px;
      color: #66ff66;
      border-bottom: 1px solid rgba(60, 255, 60, 0.3);
      padding-bottom: 5px;
    }
    .stats-card .stat-value {
      font-size: 24px;
      font-weight: bold;
      margin: 10px 0;
    }
    .stats-card .ip-list {
      max-height: 150px;
      overflow-y: auto;
      font-size: 14px;
    }
    .stats-card .ip-item {
      display: flex;
      justify-content: space-between;
      padding: 4px 0;
      border-bottom: 1px solid rgba(60, 255, 60, 0.1);
    }
    .stats-card .ip-item .count {
      color: #88ff88;
    }
    /* IPç­›é€‰æ ·å¼ */
    .ip-filter {
      display: flex;
      gap: 10px;
      margin-bottom: 15px;
      position: relative;
      z-index: 2;
    }
    .ip-filter input {
      flex: 1;
      background: rgba(0, 40, 0, 0.6);
      border: 1px solid #3cff3c;
      border-radius: 8px;
      padding: 8px 12px;
      color: #3cff3c;
      font-size: 14px;
      outline: none;
    }
    .ip-filter button {
      background: transparent;
      border: 1px solid #3cff3c;
      color: #3cff3c;
      padding: 8px 15px;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s ease;
    }
    .ip-filter button:hover {
      background: rgba(60, 255, 60, 0.2);
    }
    /* æ—¥å¿—å†…å®¹åŒº */
    .log-content {
      background-color: rgba(0, 40, 0, 0.4);
      border: 1px solid #3cff3c;
      border-radius: 8px;
      padding: 18px;
      position: relative;
      z-index: 2;
      height: 40vh;
      overflow-y: auto;
      color: #3cff3c;
      font-size: 14px;
      line-height: 1.6;
      white-space: pre-wrap;
    }
    /* æ»šåŠ¨æ¡æ ·å¼ */
    .log-content::-webkit-scrollbar,
    .stats-card .ip-list::-webkit-scrollbar,
    .log-file-list::-webkit-scrollbar {
      width: 6px;
    }
    .log-content::-webkit-scrollbar-thumb,
    .stats-card .ip-list::-webkit-scrollbar-thumb,
    .log-file-list::-webkit-scrollbar-thumb {
      background: #3cff3c;
      border-radius: 3px;
    }
    .log-content::-webkit-scrollbar-track,
    .stats-card .ip-list::-webkit-scrollbar-track,
    .log-file-list::-webkit-scrollbar-track {
      background: #000;
    }
    /* åŠ è½½çŠ¶æ€ */
    .loading {
      color: #88ff88;
      font-style: italic;
      text-align: center;
      padding: 20px;
    }
    /* é€‰ä¸­IPæ—¥å¿—é«˜äº® */
    .log-content .highlight-ip {
      background: rgba(60, 255, 60, 0.2);
      color: #ffff00;
    }
    /* å“åº”å¼é€‚é… */
    @media (min-width: 768px) {
      .terminal {
        padding: 40px 30px;
      }
      .terminal-title {
        font-size: 28px;
        height: 40px;
      }
      .log-tab {
        font-size: 18px;
        padding: 12px;
      }
      .log-content {
        font-size: 16px;
        padding: 20px;
      }
      .stats-card h3 {
        font-size: 18px;
      }
      .stats-card .stat-value {
        font-size: 28px;
      }
    }
    @media (max-width: 768px) {
      .date-selector {
        flex-direction: column;
        align-items: stretch;
      }
      .log-file-list {
        width: 100%;
      }
    }
    @media (max-width: 375px) {
      .terminal-title {
        font-size: 20px;
        height: 28px;
      }
      .terminal-header .actions button {
        width: 32px;
        height: 32px;
        font-size: 14px;
      }
      .log-tab {
        font-size: 14px;
        padding: 8px;
      }
      .log-content {
        font-size: 13px;
      }
      .stats-panel {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <div class="terminal">
    <!-- é¡¶éƒ¨æ  -->
    <div class="terminal-header">
      <div class="date">
        <span id="currentYear">2026</span>
        <span id="currentMonth">01</span>
      </div>
      <div class="actions">
        <button id="backBtn" title="è¿”å›ä¸»é¡µé¢">â†</button>
        <button id="refreshBtn" title="åˆ·æ–°æ—¥å¿—">ğŸ”„</button>
      </div>
    </div>
    <!-- ä¸»æ ‡é¢˜ -->
    <div class="terminal-title" id="titleTyping">è®¿é—®æ—¥å¿—å¯è§†åŒ–</div>
    <!-- æ—¥å¿—æ ‡ç­¾æ ï¼ˆä»…ä¿ç•™è®¿é—®æ—¥å¿—ï¼‰ -->
    <div class="log-tabs">
      <div class="log-tab active" data-type="access">è®¿é—®æ—¥å¿—</div>
    </div>
    <!-- æ–°å¢æ—¥æœŸé€‰æ‹©åŒºåŸŸ -->
    <div class="date-selector" id="dateSelector">
      <input type="date" class="date-picker" id="datePicker">
      <div class="log-file-list" id="logFileList">
        <div class="loading">åŠ è½½æ—¥å¿—åˆ—è¡¨...</div>
      </div>
    </div>
    <!-- ç»Ÿè®¡é¢æ¿ -->
    <div class="stats-panel" id="statsPanel">
      <div class="stats-card">
        <h3>æ€»è®¿é—®æ¬¡æ•°</h3>
        <div class="stat-value" id="totalVisits">0</div>
      </div>
      <div class="stats-card">
        <h3>ç‹¬ç«‹IPæ•°</h3>
        <div class="stat-value" id="uniqueIps">0</div>
      </div>
      <div class="stats-card">
        <h3>è®¿é—®TOP IP</h3>
        <div class="ip-list" id="topIpList">
          <div class="loading">åŠ è½½ä¸­...</div>
        </div>
      </div>
    </div>
    <!-- IPç­›é€‰æ¡† -->
    <div class="ip-filter" id="ipFilter">
      <input type="text" id="ipSearchInput" placeholder="è¾“å…¥IPç­›é€‰æ—¥å¿—...">
      <button id="clearFilterBtn">æ¸…ç©ºç­›é€‰</button>
    </div>
    <!-- æ—¥å¿—å†…å®¹åŒº -->
    <div class="log-content" id="logContent"></div>
  </div>
  <script>
    // DOM å…ƒç´ è·å–ï¼ˆåŒ…å«æ–°å¢æ—¥æœŸé€‰æ‹©ç›¸å…³å…ƒç´ ï¼‰
    const dom = {
      titleTyping: document.getElementById('titleTyping'),
      logContent: document.getElementById('logContent'),
      backBtn: document.getElementById('backBtn'),
      refreshBtn: document.getElementById('refreshBtn'),
      currentYear: document.getElementById('currentYear'),
      currentMonth: document.getElementById('currentMonth'),
      totalVisits: document.getElementById('totalVisits'),
      uniqueIps: document.getElementById('uniqueIps'),
      topIpList: document.getElementById('topIpList'),
      ipSearchInput: document.getElementById('ipSearchInput'),
      clearFilterBtn: document.getElementById('clearFilterBtn'),
      datePicker: document.getElementById('datePicker'),
      logFileList: document.getElementById('logFileList'),
      dateSelector: document.getElementById('dateSelector')
    };

    // å…¨å±€çŠ¶æ€ï¼ˆæ–°å¢æ—¥å¿—æ–‡ä»¶ç›¸å…³çŠ¶æ€ï¼‰
    let rawLogData = '';
    let ipStats = {
      total: 0,
      unique: 0,
      ipCounts: {}
    };
    let currentFilterIp = '';
    let logFiles = []; // æ‰€æœ‰æ—¥å¿—æ–‡ä»¶åˆ—è¡¨
    let currentFilename = ''; // å½“å‰é€‰ä¸­çš„æ—¥å¿—æ–‡ä»¶å

    // åˆå§‹åŒ–é¡µé¢
    function initPageInfo() {
      const now = new Date();
      currentYear.textContent = now.getFullYear();
      currentMonth.textContent = String(now.getMonth() + 1).padStart(2, '0');
      // è®¾ç½®æ—¥æœŸé€‰æ‹©å™¨é»˜è®¤å€¼ä¸ºä»Šå¤©ï¼ˆæ ¼å¼ï¼šYYYY-MM-DDï¼‰
      const today = now.toISOString().split('T')[0];
      dom.datePicker.value = today;
      // åˆå§‹åŒ–æ ‡é¢˜åŠ¨ç”»ã€åŠ è½½æ—¥å¿—æ–‡ä»¶åˆ—è¡¨ã€åŠ è½½ä»Šæ—¥æ—¥å¿—
      titleTypewriter();
      loadLogFiles();
      initDatePickerListener();
    }

    // æ ‡é¢˜æ‰“å­—æœºåŠ¨ç”»
    function titleTypewriter() {
      const titleText = 'è®¿é—®æ—¥å¿—å¯è§†åŒ–';
      titleTyping.textContent = '';
      let index = 0;
      const typingInterval = setInterval(() => {
        titleTyping.textContent += titleText[index];
        index++;
        if (index >= titleText.length) {
          clearInterval(typingInterval);
        }
      }, 200);
    }

    // åŠ è½½æ‰€æœ‰æ—¥å¿—æ–‡ä»¶åˆ—è¡¨
    async function loadLogFiles() {
      dom.logFileList.innerHTML = '<div class="loading">åŠ è½½æ—¥å¿—åˆ—è¡¨...</div>';
      try {
        const res = await fetch('/api/logs/files');
        const data = await res.json();
        if (data.success) {
          logFiles = data.files;
          renderLogFileList();
          // é»˜è®¤é€‰ä¸­ç¬¬ä¸€ä¸ªæ–‡ä»¶ï¼ˆæœ€æ–°æ—¥æœŸï¼‰
          if (logFiles.length > 0) {
            selectLogFile(logFiles[0]);
          }
        } else {
          dom.logFileList.innerHTML = '<div class="loading">åŠ è½½å¤±è´¥</div>';
        }
      } catch (err) {
        dom.logFileList.innerHTML = '<div class="loading">åŠ è½½å¤±è´¥</div>';
      }
    }

    // æ¸²æŸ“æ—¥å¿—æ–‡ä»¶åˆ—è¡¨ï¼ˆæ˜¾ç¤ºä¸ºä¸­æ–‡æ—¥æœŸæ ¼å¼ï¼‰
    function renderLogFileList() {
      if (logFiles.length === 0) {
        dom.logFileList.innerHTML = '<div class="loading">æš‚æ— æ—¥å¿—æ–‡ä»¶</div>';
        return;
      }
      dom.logFileList.innerHTML = '';
      logFiles.forEach(file => {
        // è§£ææ–‡ä»¶åä¸­çš„æ—¥æœŸï¼ˆæ ¼å¼ï¼šaccess-2024-05-20.log â†’ 2024-05-20ï¼‰
        const dateStr = file.replace('access-', '').replace('.log', '');
        // æ ¼å¼åŒ–ä¸ºä¸­æ–‡æ—¥æœŸæ˜¾ç¤ºï¼ˆ2024-05-20 â†’ 2024å¹´5æœˆ20æ—¥ï¼‰
        const [year, month, day] = dateStr.split('-');
        const displayDate = `${year}å¹´${parseInt(month)}æœˆ${parseInt(day)}æ—¥`;
        const el = document.createElement('div');
        el.className = `log-file-item ${currentFilename === file ? 'active' : ''}`;
        el.textContent = displayDate;
        el.dataset.filename = file;
        el.addEventListener('click', () => selectLogFile(file));
        dom.logFileList.appendChild(el);
      });
    }

    // é€‰ä¸­æ—¥å¿—æ–‡ä»¶å¹¶åŠ è½½æ—¥å¿—
    async function selectLogFile(filename) {
      currentFilename = filename;
      // æ›´æ–°æ–‡ä»¶åˆ—è¡¨é€‰ä¸­çŠ¶æ€
      document.querySelectorAll('.log-file-item').forEach(el => {
        el.classList.toggle('active', el.dataset.filename === filename);
      });
      // åŠ è½½é€‰ä¸­æ–‡ä»¶çš„æ—¥å¿—
      await loadLogsByFilename(filename);
    }

    // æŒ‰æ–‡ä»¶ååŠ è½½æ—¥å¿—
    async function loadLogsByFilename(filename) {
      dom.logContent.innerHTML = '<div class="loading">åŠ è½½ä¸­...</div>';
      try {
        const res = await fetch(`/api/logs/${filename}`);
        if (!res.ok) throw new Error('æ—¥å¿—åŠ è½½å¤±è´¥');
        const text = await res.text();
        rawLogData = text;
        // è§£æç»Ÿè®¡æ•°æ®å¹¶æ›´æ–°é¢æ¿
        parseAccessLogStats(text);
        // åº”ç”¨IPç­›é€‰
        if (currentFilterIp) {
          filterLogsByIp();
        } else {
          dom.logContent.textContent = text;
        }
        dom.logContent.scrollTop = dom.logContent.scrollHeight;
      } catch (err) {
        dom.logContent.innerHTML = `<div class="loading">${err.message}</div>`;
        topIpList.innerHTML = `<div class="loading">${err.message}</div>`;
      }
    }

    // æ—¥æœŸé€‰æ‹©å™¨äº‹ä»¶ç›‘å¬
    function initDatePickerListener() {
      dom.datePicker.addEventListener('change', (e) => {
        const selectedDate = e.target.value; // æ ¼å¼ï¼šYYYY-MM-DD
        if (!selectedDate) return;
        // è½¬æ¢ä¸ºæ—¥å¿—æ–‡ä»¶åæ ¼å¼ï¼šaccess-YYYY-MM-DD.log
        const targetFilename = `access-${selectedDate}.log`;
        // æ£€æŸ¥æ˜¯å¦å­˜åœ¨è¯¥æ—¥æœŸçš„æ—¥å¿—æ–‡ä»¶
        const exists = logFiles.includes(targetFilename);
        if (exists) {
          selectLogFile(targetFilename);
        } else {
          dom.logContent.innerHTML = '<div class="loading">è¯¥æ—¥æœŸæ— æ—¥å¿—è®°å½•</div>';
          // æ¸…ç©ºç»Ÿè®¡é¢æ¿
          totalVisits.textContent = 0;
          uniqueIps.textContent = 0;
          topIpList.innerHTML = '<div class="loading">æ— æ•°æ®</div>';
        }
      });
    }

    // è§£æè®¿é—®æ—¥å¿—ç»Ÿè®¡æ•°æ®
    function parseAccessLogStats(logText) {
      const lines = logText.split('\n').filter(line => line.trim());
      const ipCounts = {};
      const ipRegex = /\b(?:\d{1,3}\.){3}\d{1,3}\b/g;
      
      lines.forEach(line => {
        const matches = line.match(ipRegex);
        if (matches && matches.length > 0) {
          const ip = matches[0];
          ipCounts[ip] = (ipCounts[ip] || 0) + 1;
        }
      });
      
      ipStats = {
        total: lines.length,
        unique: Object.keys(ipCounts).length,
        ipCounts: ipCounts
      };
      
      updateStatsPanel();
    }

    // æ›´æ–°ç»Ÿè®¡é¢æ¿
    function updateStatsPanel() {
      totalVisits.textContent = ipStats.total;
      uniqueIps.textContent = ipStats.unique;
      
      const sortedIps = Object.entries(ipStats.ipCounts)
        .sort((a, b) => b[1] - a[1])
        .slice(0, 8);
      
      if (sortedIps.length === 0) {
        topIpList.innerHTML = '<div class="loading">æš‚æ— IPæ•°æ®</div>';
        return;
      }
      
      topIpList.innerHTML = '';
      sortedIps.forEach(([ip, count], index) => {
        const ipItem = document.createElement('div');
        ipItem.className = 'ip-item';
        ipItem.innerHTML = `
          <span>${index + 1}. ${ip}</span>
          <span class="count">${count}æ¬¡</span>
        `;
        ipItem.addEventListener('click', () => {
          currentFilterIp = ip;
          ipSearchInput.value = ip;
          filterLogsByIp();
        });
        topIpList.appendChild(ipItem);
      });
    }

    // IPç­›é€‰æ—¥å¿—
    function filterLogsByIp() {
      if (!rawLogData) return;
      
      if (!currentFilterIp) {
        dom.logContent.textContent = rawLogData;
        return;
      }
      
      const lines = rawLogData.split('\n');
      let filteredHtml = '';
      
      lines.forEach(line => {
        if (line.includes(currentFilterIp)) {
          const highlightedLine = line.replace(
            new RegExp(currentFilterIp, 'g'),
            `<span class="highlight-ip">${currentFilterIp}</span>`
          );
          filteredHtml += highlightedLine + '\n';
        }
      });
      
      dom.logContent.innerHTML = filteredHtml || '<div class="loading">æœªæ‰¾åˆ°è¯¥IPçš„æ—¥å¿—è®°å½•</div>';
    }

    // äº‹ä»¶ç»‘å®š
    function bindEvents() {
      // è¿”å›ä¸»é¡µé¢
      backBtn.addEventListener('click', () => {
        window.location.href = '/';
      });
      
      // æ‰‹åŠ¨åˆ·æ–°ï¼ˆæ–°å¢é‡æ–°åŠ è½½æ–‡ä»¶åˆ—è¡¨ï¼‰
      refreshBtn.addEventListener('click', () => {
        currentFilterIp = '';
        ipSearchInput.value = '';
        loadLogFiles(); // åˆ·æ–°æ—¥å¿—æ–‡ä»¶åˆ—è¡¨
      });
      
      // IPç­›é€‰
      ipSearchInput.addEventListener('input', (e) => {
        currentFilterIp = e.target.value.trim();
        filterLogsByIp();
      });
      
      // æ¸…ç©ºç­›é€‰
      clearFilterBtn.addEventListener('click', () => {
        currentFilterIp = '';
        ipSearchInput.value = '';
        if (rawLogData) {
          dom.logContent.textContent = rawLogData;
        }
      });
    }

    // åˆå§‹åŒ–
    window.onload = () => {
      initPageInfo();
      bindEvents();
    };
  </script>
</body>
</html>